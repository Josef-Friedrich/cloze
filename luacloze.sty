\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{luacloze}

\RequirePackage{fontspec}
\RequirePackage{luatexbase-mcb}
\RequirePackage{xcolor}
\RequirePackage{kvoptions}

\directlua{
  luacloze = require("luacloze")
}

% Inspired by:
% Three things you can do with LuaTEX that
% would be extremely painful otherwise
%   --Paul Isambert; TUGBoat Volume 31, Number 3, 2010

\SetupKeyvalOptions{
  family=LC,
  prefix=LC@
}

\DeclareStringOption[0.4pt]{thickness}
\DeclareStringOption[3pt]{descender}
\DeclareStringOption[{0,0,1}]{textcolor}
\DeclareStringOption[{0,0,0}]{linecolor}
% Affects only \clozefix
\DeclareStringOption[l]{align}
\DeclareStringOption[2cm]{width}

\DeclareVoidOption{show}{\directlua{luacloze.options.show_text = true}}
\DeclareVoidOption{hide}{\directlua{luacloze.options.show_text = false}}

\ProcessKeyvalOptions{LC}

\define@key{LClocal}{width}[]{\def\LC@local@width{#1}}
\define@key{LClocal}{descender}[]{\def\LC@local@descender{#1}}

\setkeys{LClocal}{width,descender}%

\newcommand{\pdf@colorstack}[1]{\csname\string\color@#1\endcsname}

\newcommand{\setluavalues}{%
  \definecolor{clozelinecolor}{rgb}{\LC@linecolor}%
  \definecolor{clozetextcolor}{rgb}{\LC@textcolor}%
%
  \directlua{
    luacloze.options.thickness = '\LC@thickness'
    luacloze.options.descender = '\LC@descender'
    luacloze.options.linecolor = '\pdf@colorstack{clozelinecolor}'
    luacloze.options.textcolor = '\pdf@colorstack{clozetextcolor}'
    luacloze.options.width = '\LC@width'
    luacloze.options.align = '\LC@align'

    luacloze.get_options(luacloze.options)
  }%
}

\setluavalues

\newcommand{\setcloze}[1]{\setkeys{LC}{#1}\setluavalues}

%-----------------------------------------------------------------------
% Public macros
%-----------------------------------------------------------------------

\newlength{\clozemargin}
\setlength{\clozemargin}{0.1cm}

%%
% \cloze{Lorem ipsum}
%%
\newcommand{\cloze}[1]{%
  \strut\directlua{
    luacloze.register("basic")
    luacloze.marker('basic', 'start')
  }%
  {%
    \clozefont%
    \hspace{\clozemargin}%
    #1%
    \hspace{\clozemargin}%
  }%
  \strut\directlua{luacloze.marker('basic', 'stop')}%
}

%%
% \clozefix{Lorem ipsum}
%
% Creates a cloze on one line with a fixed length.
%%
\newcommand{\clozefix}[2][]{%
  \setkeys{LClocal}{width,descender}%
  \setkeys{LClocal}{#1}%
  \directlua{luacloze.register("fix")}%
  \directlua{
    local values = {
      ['width'] = '\LC@local@width',
      ['descender'] = '\LC@local@descender'
    }
    luacloze.marker('fix', 'start', values)
  }%
  {%
    \clozefont%
    #2%
  }%
  \cloze@marker@stop{fix}%
  \directlua{luacloze.marker('fix', 'stop')}%
}

%%
% \begin{clozepar}
% Lorem ipsum.
% \end{clozepar}
\newenvironment{clozepar}%
{%
  \par%
  \directlua{
    luacloze.register('par')
    luacloze.marker('par', 'start')
  }%
  \clozefont%
}%
{%
  \directlua{luacloze.marker('par', 'stop')}%
  \par%
  \directlua{luacloze.unregister('par')}%
}

%%
% \clozeend{Lorem ipsum}
%
% This command forces a line break and creates a cloze line that extends
% to the end of the text line.
%%
\newcommand{\clozeend}[1]{%
  \directlua{register('toend')}%
  \directlua{luacloze.marker('topar', 'start')}%
  #1%
  \newline%
  \directlua{luacloze.marker('topar', 'stop')}%
}

%%
% \showclozetext
%%
\newcommand{\showclozetext}{\directlua{luacloze.options.show_text = true}}

%%
% \hideclozetext
%%
\newcommand{\hideclozetext}{\directlua{luacloze.options.show_text = false}}

%-----------------------------------------------------------------------
% Formats
%-----------------------------------------------------------------------

%%
% \clozefont
%%
\newcommand{\clozefont}{\itshape}
