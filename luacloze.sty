\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{luacloze}

\RequirePackage{fontspec}
\RequirePackage{luatexbase-mcb}
\RequirePackage{xcolor}
\RequirePackage{kvoptions}

\directlua{
  require("luacloze")
}

% Inspired by:
% Three things you can do with LuaTEX that
% would be extremely painful otherwise
%   --Paul Isambert; TUGBoat Volume 31, Number 3, 2010

\SetupKeyvalOptions{
  family=LC,
  prefix=LC@
}

\DeclareStringOption[0.4pt]{thickness}
\DeclareStringOption[3pt]{descender}
\DeclareStringOption[{0,0,1}]{textcolor}
\DeclareStringOption[{0,0,0}]{linecolor}

\DeclareVoidOption{show}{\directlua{show_cloze_text = true}}
\DeclareVoidOption{hide}{\directlua{show_cloze_text = false}}

\ProcessKeyvalOptions{LC}

\newcommand{\pdf@colorstack}[1]{\csname\string\color@#1\endcsname}

\newcommand{\setluavalues}{%
  \definecolor{clozelinecolor}{rgb}{\LC@linecolor}%
  \definecolor{clozetextcolor}{rgb}{\LC@textcolor}%
%
  \directlua{
    thickness = '\LC@thickness'
    descender = '\LC@descender'
    linecolor = '\pdf@colorstack{clozelinecolor}'
    textcolor = '\pdf@colorstack{clozetextcolor}'
  }%
}

\setluavalues

\newcommand{\setcloze}[1]{\setkeys{LC}{#1}\setluavalues}

%-----------------------------------------------------------------------
% Public macros
%-----------------------------------------------------------------------

\newlength{\clozemargin}
\setlength{\clozemargin}{0.1cm}

%%
% \cloze{Lorem ipsum}
%%
\newcommand{\cloze}[1]{%
  \directlua{
    register_callback("post_linebreak_filter", process.cloze, "cloze")
  }%
  \strut%
  \clozemarker{begin-cloze}%
  {%
    \clozefont%
    \hspace{\clozemargin}%
    #1%
    \hspace{\clozemargin}%
  }%
  \clozemarker{end-cloze}%
}

%%
% \begin{clozepar}
% Lorem ipsum.
% \end{clozepar}
%%
\newenvironment{clozepar}%
{%
  \directlua{
    register_callback("post_linebreak_filter", process.clozepar, "clozepar")
  }%
  \clozemarker{begin-clozepar}%
}%
{\par\clozemarker{end-clozepar}}
%%
% \clozeend{Lorem ipsum}
%
% This command forces a line break and creates a cloze line that extends
% to the end of the text line.
%%
\newcommand{\clozeend}[1]{%
  \directlua{
    register_callback("post_linebreak_filter", process.clozeend, "clozeend")
  }%
  \clozemarker{begin-clozeend}%
  #1%
  \newline%
  \clozemarker{end-clozeend}
}

%%
% \clozefixed{Lorem ipsum}
%
% Creates a cloze on one line with a fixed length.
%%
\newcommand{\clozefixed}[2][]{%
  \directlua{
    register_callback("pre_linebreak_filter", process.clozefixed, "clozefixed")
  }%
  \strut
  \clozemarker{begin-clozefixed}%
  #2%
  \clozemarker{end-clozefixed}
}

%%
% \showclozetext
%%
\newcommand{\showclozetext}{\directlua{show_cloze_text = true}}

%%
% \hideclozetext
%%
\newcommand{\hideclozetext}{\directlua{show_cloze_text = false}}

%-----------------------------------------------------------------------
% Formats
%-----------------------------------------------------------------------

%%
% \clozefont
%%
\newcommand{\clozefont}{\itshape}

%-----------------------------------------------------------------------
% Helper
%-----------------------------------------------------------------------

%%
% \clozemarker
%%
\newcommand{\clozemarker}[1]{%
  \directlua{
    local whatsit = whatsit_userdefined("#1")
    node.write(whatsit)
  }%
}
