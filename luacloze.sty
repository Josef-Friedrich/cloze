\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{luacloze}

% Three things you can do with LuaTEX that
% would be extremely painful otherwise
% Paul Isambert

% TUGBoat
% Volume 31, Number 3, 2010

\RequirePackage{fontspec}
\RequirePackage{luatexbase-mcb}
\RequirePackage{color}

\directlua{
  require("luacloze")
  luatexbase.add_to_callback("post_linebreak_filter", get_lines, "get_lines")
}

%-----------------------------------------------------------------------
% Öffentliche Makros
%-----------------------------------------------------------------------

%%
% \cloze{Lorem ipsum}
%%
\newcommand{\cloze}[1]{%
  \clozemarker{1}%
  {%
    \clozefont%
    \hspace{0.1cm}%
    #1%
    \hspace{0.1cm}%
  }%
  \clozemarker{2}%
}

%%
% \showtext
%%
\newcommand{\showtext}{\directlua{show_cloze_text = true}}

%%
% \hidetext
%%
\newcommand{\hidetext}{\directlua{show_cloze_text = false}}

%%
% \clozemarker
%%
\newcommand{\clozemarker}[1]{%
  \directlua{
    local whatsit = whatsit_userdefined(#1)
    node.write(whatsit)
  }%
}

%-----------------------------------------------------------------------
% Lückenformatierung
%-----------------------------------------------------------------------

%%
% \clozefont
%%
\newcommand{\clozefont}{\itshape}

%%
% \clozedescender{3pt}
%%
\newcommand{\clozedescender}[1]{\wert[descender]{#1}}

%%
% \clozelinethickness{3pt}
%%
\newcommand{\clozelinethickness}[1]{\wert[thickness]{#1}}

%%
% \clozeabstand{0.1cm}
%%
%\newcommand{\clozeabstand}[1][0.1cm]{\wert[clozeabstand]{#1}}


%-----------------------------------------------------------------------
% Colors
%-----------------------------------------------------------------------

%%
% \clozecolor
%%
\def\clozecolor#1{\csname\string\color@#1\endcsname\space}

%%
% \clozetextcolor{rgb}{0.2,1,0.9}
%%
\newcommand{\clozetextcolor}[2]{
  \definecolor{clozetextcolor}{#1}{#2}
  \directlua{clozetextcolor = "\clozecolor{clozetextcolor}"}
}


%%
% \clozelinecolor{rgb}{1,0.5,0.7}
%%
\newcommand{\clozelinecolor}[2]{
  \definecolor{clozelinecolor}{#1}{#2}
  \directlua{clozelinecolor = "\clozecolor{clozelinecolor}"}
}

