\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{luacloze}

% Inspired by:
% Three things you can do with LuaTEX that
% would be extremely painful otherwise
%   --Paul Isambert; TUGBoat Volume 31, Number 3, 2010

\RequirePackage{kvoptions}

\SetupKeyvalOptions{
  family=LC,
  prefix=LC@
}

\DeclareStringOption[0.4pt]{thickness}
\DeclareStringOption[3pt]{descender}

\ProcessKeyvalOptions*

\RequirePackage{fontspec}
\RequirePackage{luatexbase-mcb}
\RequirePackage{color}

\newcommand{\setluavalues}{\directlua{
  thickness = '\LC@thickness'
  descender = '\LC@descender'
}}

\setluavalues

\directlua{
  require("luacloze")
  luatexbase.add_to_callback("post_linebreak_filter", get_lines, "get_lines")
}

\newcommand{\setcloze}[1]{\setkeys{LC}{#1}\setluavalues}

%-----------------------------------------------------------------------
% Public macros
%-----------------------------------------------------------------------

\newlength{\clozemargin}
\setlength{\clozemargin}{0.1cm}

%%
% \cloze{Lorem ipsum}
%%
\newcommand{\cloze}[1]{%
  \clozemarker{1}%
  {%
    \clozefont%
    \hspace{\clozemargin}%
    #1%
    \hspace{\clozemargin}%
  }%
  \clozemarker{2}%
}

%%
% \showclozetext
%%
\newcommand{\showclozetext}{\directlua{show_cloze_text = true}}

%%
% \hideclozetext
%%
\newcommand{\hideclozetext}{\directlua{show_cloze_text = false}}

%-----------------------------------------------------------------------
% Formats
%-----------------------------------------------------------------------

%%
% \clozefont
%%
\newcommand{\clozefont}{\itshape}

%-----------------------------------------------------------------------
% Colors
%-----------------------------------------------------------------------

%%
% \clozecolor
%%
\def\clozecolor#1{\csname\string\color@#1\endcsname\space}

%%
% \clozetextcolor{rgb}{0.2,1,0.9}
%%
\newcommand{\clozetextcolor}[2]{
  \definecolor{clozetextcolor}{#1}{#2}
  \directlua{clozetextcolor = "\clozecolor{clozetextcolor}"}
}

%%
% \clozelinecolor{rgb}{1,0.5,0.7}
%%
\newcommand{\clozelinecolor}[2]{
  \definecolor{clozelinecolor}{#1}{#2}
  \directlua{clozelinecolor = "\clozecolor{clozelinecolor}"}
}

%-----------------------------------------------------------------------
% Helper
%-----------------------------------------------------------------------

%%
% \clozemarker
%%
\newcommand{\clozemarker}[1]{%
  \directlua{
    local whatsit = whatsit_userdefined(#1)
    node.write(whatsit)
  }%
}
