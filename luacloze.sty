\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{luacloze}

\RequirePackage{fontspec}
\RequirePackage{luatexbase-mcb}
\RequirePackage{xcolor}
\RequirePackage{kvoptions}

\directlua{
  luacloze = require("luacloze")
}

%-----------------------------------------------------------------------
% Global options
%-----------------------------------------------------------------------

% LC = luacloze
\SetupKeyvalOptions{
  family=LC,
  prefix=LC@
}

% align
\DeclareStringOption{align} % Affects only \clozefix

% descender
\DeclareStringOption{descender}

% hide
\DeclareVoidOption{hide}{\directlua{luacloze.show_text = false}}

% linecolor
\DeclareStringOption{linecolor}

% show
\DeclareVoidOption{show}{\directlua{luacloze.show_text = true}}

% textcolor
\DeclareStringOption{textcolor}

% thickness
\DeclareStringOption{thickness}

% width
\DeclareStringOption{width} % Affects only \clozefix

\ProcessKeyvalOptions{LC}

%-----------------------------------------------------------------------
% Set global options
%-----------------------------------------------------------------------

\newcommand{\pdf@colorstack}[1]{\csname\string\color@#1\endcsname}

\newcommand{\set@lua@values}{%
%
  \directlua{
    local options = {
      ['align'] = '\LC@align',
      ['descender'] = '\LC@descender',
      ['linecolor'] = '\pdf@colorstack{\LC@linecolor}',
      ['textcolor'] = '\pdf@colorstack{\LC@textcolor}',
      ['thickness'] = '\LC@thickness',
      ['width'] = '\LC@width',
    }

    luacloze.set_global_options(options)
  }%
}

\set@lua@values

%-----------------------------------------------------------------------
% Local options
%-----------------------------------------------------------------------

% LCL = luacloze local

% align
\define@key{LCL}{align}[]{\def\LCL@align{#1}} % Affects only \clozefix

% descender
\define@key{LCL}{descender}[]{\def\LCL@descender{#1}}

% hide
\define@key{LCL}{hide}[true]{\def\LCL@hide{#1}}

% linecolor
\define@key{LCL}{linecolor}[]{\def\LCL@linecolor{\pdf@colorstack{#1}}}

% show
\define@key{LCL}{show}[true]{\def\LCL@show{#1}}

% textcolor
\define@key{LCL}{textcolor}[]{\def\LCL@textcolor{\pdf@colorstack{#1}}}

% thickness
\define@key{LCL}{thickness}[]{\def\LCL@thickness{#1}}

% width
\define@key{LCL}{width}[]{\def\LCL@width{#1}} % Affects only \clozefix

\newcommand{\set@local@keys}[1]{%
  \setkeys{LCL}{
    align=unset,
    descender=unset,
    hide=unset,
    linecolor=,
    show=unset,
    textcolor=,
    thickness=unset,
    width=unset,
  }%
  \setkeys{LCL}{#1}%
}

\newcommand{\set@start@marker}[1]{%
  \strut\directlua{
    luacloze.register('#1')
    local values = {
      ['align'] = '\LCL@align',
      ['descender'] = '\LCL@descender',
      ['hide'] = '\LCL@hide',
      ['linecolor'] = '\LCL@linecolor',
      ['show'] = '\LCL@show',
      ['textcolor'] = '\LCL@textcolor',
      ['thickness'] = '\LCL@thickness',
      ['width'] = '\LCL@width',
    }
    luacloze.marker('#1', 'start', values)
  }%
}

\newcommand{\set@stop@marker}[1]{%
  \strut\directlua{
    luacloze.marker('#1', 'stop')
  }%
}

%-----------------------------------------------------------------------
% Public macros
%-----------------------------------------------------------------------

%%
% \setcloze{key=value}
%%
\newcommand{\setcloze}[1]{\setkeys{LC}{#1}\set@lua@values}

%%
% \cloze{Lorem ipsum}
%%
\newcommand{\cloze}[2][]{%
  \set@local@keys{#1}%
  \set@start@marker{basic}%
  {%
    \clozefont%
    \kern5pt#2\kern5pt%
  }%
  \set@stop@marker{basic}%
}

%%
% \clozefix{Lorem ipsum}
%
% Creates a cloze on one line with a fixed length.
%%
\newcommand{\clozefix}[2][]{%
  \set@local@keys{#1}%
  \set@start@marker{fix}%
  {%
    \clozefont%
    #2%
  }%
  \set@stop@marker{fix}%
}

%%
% \begin{clozepar}
% Lorem ipsum.
% \end{clozepar}
\newenvironment{clozepar}[1][]%
{%
  \par%
  \set@local@keys{#1}%
  \set@start@marker{par}%
  \clozefont%
}%
{%
  \set@stop@marker{par}%
  \par%
  \directlua{luacloze.unregister('par')}%
}

%%
% \clozetoend{Lorem ipsum}
%
% This command forces a line break and creates a cloze line that extends
% to the end of the text line.
%%
%\newcommand{\clozetoend}[2][]{%
%  \set@start@marker{toend}%
%  #1%
%  \set@stop@marker{toend}%
%  \par%
%}

\newcommand{\clozetoend}[2][]{%
  \cloze[#1]{#2}\clozefill[#1]\par%
}

%%
% \clozefont
%%
\newcommand{\clozefont}{\itshape}

%\def\cloze@hrule{
%  \hrule
%    height \dimexpr-\LC@descender+\LC@thickness
%    depth \LC@descender%
%}

%\def\cloze@fill#1{%
%  \leavevmode%
%  \leaders%
%  \cloze@hrule%
%  #1%
%  \kern 0pt%
%}

%\def\clozefill{\cloze@fill{\hfill}}
%\def\clozefil{\cloze@fill{\hfil}}

%%
% \clozefill{Lorem ipsum}
%
% Creates a cloze on one line with a fixed length.
%%
\newcommand{\clozefill}[1][]{%
  \set@local@keys{#1}%
  \strut
  \directlua{
    local options = {
      ['descender'] = '\LCL@descender',
      ['linecolor'] = '\LCL@linecolor',
      ['textcolor'] = '\LCL@textcolor',
      ['thickness'] = '\LCL@thickness',
      ['width'] = '\LCL@width',
    }
    luacloze.hfill(options)
  }%
  \strut
}