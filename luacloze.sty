\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{luacloze}

\RequirePackage{fontspec}
\RequirePackage{luatexbase-mcb}
\RequirePackage{xcolor}
\RequirePackage{kvoptions}

\directlua{
  luacloze = require("luacloze")
}

%-----------------------------------------------------------------------
% Global options
%-----------------------------------------------------------------------

% LC = luacloze
\SetupKeyvalOptions{
  family=LC,
  prefix=LC@
}

% align
\DeclareStringOption[l]{align} % Affects only \clozefix

% descender
\DeclareStringOption[3pt]{descender}

% hide
\DeclareVoidOption{hide}{\directlua{luacloze.options.show_text = false}}

% linecolor
\DeclareStringOption[black]{linecolor}

% show
\DeclareVoidOption{show}{\directlua{luacloze.options.show_text = true}}

% textcolor
\DeclareStringOption[blue]{textcolor}

% thickness
\DeclareStringOption[0.4pt]{thickness}

% width
\DeclareStringOption[2cm]{width} % Affects only \clozefix

\ProcessKeyvalOptions{LC}

%-----------------------------------------------------------------------
% Local options
%-----------------------------------------------------------------------

% LCL = luacloze local

% align
\define@key{LCL}{align}[]{\def\LCL@align{#1}} % Affects only \clozefix

% descender
\define@key{LCL}{descender}[]{\def\LCL@descender{#1}}

% hide
\define@key{LCL}{hide}[true]{\def\LCL@hide{#1}}

% linecolor
\define@key{LCL}{linecolor}[]{\def\LCL@linecolor{\pdf@colorstack{#1}}}

% show
\define@key{LCL}{show}[true]{\def\LCL@show{#1}}

% textcolor
\define@key{LCL}{textcolor}[]{\def\LCL@textcolor{\pdf@colorstack{#1}}}

% thickness
\define@key{LCL}{thickness}[]{\def\LCL@thickness{#1}}

% width
\define@key{LCL}{width}[]{\def\LCL@width{#1}} % Affects only \clozefix

%-----------------------------------------------------------------------
% Set global options
%-----------------------------------------------------------------------

\newcommand{\pdf@colorstack}[1]{\csname\string\color@#1\endcsname}

\newcommand{\set@lua@values}{%
%
  \directlua{
    luacloze.options.align = '\LC@align'
    luacloze.options.descender = '\LC@descender'
    luacloze.options.linecolor = '\pdf@colorstack{\LC@linecolor}'
    luacloze.options.textcolor = '\pdf@colorstack{\LC@textcolor}'
    luacloze.options.thickness = '\LC@thickness'
    luacloze.options.width = '\LC@width'

    luacloze.get_options(luacloze.options)
  }%
}

\set@lua@values

%-----------------------------------------------------------------------
% Public macros
%-----------------------------------------------------------------------

%%
% \setcloze{key=value}
%%
\newcommand{\setcloze}[1]{\setkeys{LC}{#1}\set@lua@values}

%%
% \cloze{Lorem ipsum}
%%
\newcommand{\cloze}[2][]{%
  \setkeys{LCL}{
    descender,
    hide=unset,
    linecolor,
    show=unset,
    textcolor
  }%
  \setkeys{LCL}{#1}%
  \strut\directlua{
    luacloze.register('basic')
    local values = {
      ['descender'] = '\LCL@descender',
      ['hide'] = '\LCL@hide',
      ['linecolor'] = '\LCL@linecolor',
      ['show'] = '\LCL@show',
      ['textcolor'] = '\LCL@textcolor',
    }
    luacloze.marker('basic', 'start', values)
  }%
  {%
    \clozefont%
    #2%
  }%
  \strut\directlua{luacloze.marker('basic', 'stop')}%
}

%%
% \clozefix{Lorem ipsum}
%
% Creates a cloze on one line with a fixed length.
%%
\newcommand{\clozefix}[2][]{%
  \setkeys{LCL}{
    align,
    descender,
    hide=unset,
    linecolor,
    show=unset,
    textcolor,
    thickness,
    width,
  }%
  \setkeys{LCL}{#1}%
  \directlua{luacloze.register("fix")}%
  \strut\directlua{
    local values = {
      ['align'] = '\LCL@align',
      ['descender'] = '\LCL@descender',
      ['hide'] = '\LCL@hide',
      ['linecolor'] = '\LCL@linecolor',
      ['show'] = '\LCL@show',
      ['textcolor'] = '\LCL@textcolor',
      ['thickness'] = '\LCL@thickness',
      ['width'] = '\LCL@width',
    }
    luacloze.marker('fix', 'start', values)
  }%
  {%
    \clozefont%
    #2%
  }%
  \strut\directlua{luacloze.marker('fix', 'stop')}%
}

%%
% \begin{clozepar}
% Lorem ipsum.
% \end{clozepar}
\newenvironment{clozepar}%
{%
  \par%
  \strut\directlua{
    luacloze.register('par')
    luacloze.marker('par', 'start')
  }%
  \clozefont%
}%
{%
  \strut\directlua{luacloze.marker('par', 'stop')}%
  \par%
  \directlua{luacloze.unregister('par')}%
}

%%
% \clozetoend{Lorem ipsum}
%
% This command forces a line break and creates a cloze line that extends
% to the end of the text line.
%%
\newcommand{\clozetoend}[1]{%
  \directlua{luacloze.register('toend')}%
  \strut\directlua{luacloze.marker('topar', 'start')}%
  #1%
  \strut\directlua{luacloze.marker('topar', 'stop')}%
  \par%
}

%%
% \clozefont
%%
\newcommand{\clozefont}{\itshape}
