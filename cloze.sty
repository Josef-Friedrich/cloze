\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{cloze}

\RequirePackage{luatexbase-mcb}
\RequirePackage{xcolor}
\RequirePackage{kvoptions}

\directlua{
  cloze = require("cloze")
}

%-----------------------------------------------------------------------
% Local macros
%-----------------------------------------------------------------------

\newcommand{\cloze@set@to@global}{%
 \directlua{cloze.set_is_global(true)}%
}

\newcommand{\cloze@set@to@local}{%
  \directlua{
  cloze.unset_local_options()
  cloze.set_is_global(false)
  }%
}

\newcommand{\cloze@set@option}[2][]{%
  \directlua{cloze.set_option('#1', '#2')}%
}

\newcommand{\cloze@color}[1]{\csname\string\color@#1\endcsname}

\newcommand{\cloze@set@local@options}[1]{%
  \cloze@set@to@local%
  \kvsetkeys{LC}{#1}%
}

\newcommand{\cloze@start@marker}[1]{%
  \strut\directlua{
    cloze.register('#1')
    cloze.marker('#1', 'start')
    cloze.process_options()
  }%
}

\newcommand{\cloze@stop@marker}[1]{%
  \strut\directlua{
    cloze.marker('#1', 'stop')
  }%
}

\newcommand{\cloze@margin}[1]{%
  \directlua{cloze.margin()}%
  #1%
  \directlua{cloze.margin()}%
}

%-----------------------------------------------------------------------
% Options
%-----------------------------------------------------------------------

\cloze@set@to@global

% LC = cloze
\SetupKeyvalOptions{
  family=LC,
  prefix=LC@
}

% align
\DeclareStringOption{align} % Affects only \clozefix
\define@key{LC}{align}[]{\cloze@set@option[align]{#1}}

% descender
\DeclareStringOption{descender}
\define@key{LC}{descender}[]{\cloze@set@option[descender]{#1}}

% hide
\DeclareVoidOption{hide}{\cloze@set@option[hide]{true}}

% linecolor
\DeclareStringOption{linecolor}
\define@key{LC}{linecolor}[]{\cloze@set@option[linecolor]{\cloze@color{#1}}}

% margin
\DeclareStringOption{margin}
\define@key{LC}{margin}[]{\cloze@set@option[margin]{#1}}

% show
\DeclareVoidOption{show}{\cloze@set@option[show]{true}}

% textcolor
\DeclareStringOption{textcolor}
\define@key{LC}{textcolor}[]{\cloze@set@option[textcolor]{\cloze@color{#1}}}

% thickness
\DeclareStringOption{thickness}
\define@key{LC}{thickness}[]{\cloze@set@option[thickness]{#1}}

% width
\DeclareStringOption{width} % Affects only \clozefix
\define@key{LC}{width}[]{\cloze@set@option[width]{#1}}

\ProcessKeyvalOptions{LC}

%-----------------------------------------------------------------------
% Public macros
%-----------------------------------------------------------------------

%%
% \setcloze{key=value}
%%
\newcommand{\setcloze}[1]{%
  \cloze@set@to@global%
  \kvsetkeys{LC}{#1}%
}

%%
% \cloze{Lorem ipsum}
%%
\newcommand{\cloze}[2][]{%
  \cloze@set@local@options{#1}%
  \cloze@start@marker{basic}%
  {%
    \clozefont%
    \cloze@margin{#2}%
  }%
  \cloze@stop@marker{basic}%
}

%%
% \clozefix{Lorem ipsum}
%
% Creates a cloze on one line with a fixed length.
%%
\newcommand{\clozefix}[2][]{%
  \cloze@set@local@options{#1}%
  \cloze@start@marker{fix}%
  {%
    \clozefont%
    \cloze@margin{#2}%
  }%
  \cloze@stop@marker{fix}%
}

%%
% \begin{clozepar}
% Lorem ipsum.
% \end{clozepar}
\newenvironment{clozepar}[1][]%
{%
  \par%
  \cloze@set@local@options{#1}%
  \cloze@start@marker{par}%
  \clozefont%
}%
{%
  \cloze@stop@marker{par}%
  \par%
  \directlua{cloze.unregister('par')}%
}

%%
% \clozetoend{Lorem ipsum}
%
% This command forces a line break and creates a cloze line that extends
% to the end of the text line.
%%
%\newcommand{\clozetoend}[2][]{%
%  \cloze@start@marker{toend}%
%  #1%
%  \cloze@stop@marker{toend}%
%  \par%
%}

\newcommand{\clozetoend}[2][]{%
  \cloze[#1]{#2}\clozefill[#1]\par%
}

%%
% \clozefont
%%
\newcommand{\clozefont}{\itshape}

%\def\cloze@hrule{
%  \hrule
%    height \dimexpr-\LC@descender+\LC@thickness
%    depth \LC@descender%
%}

%\def\cloze@fill#1{%
%  \leavevmode%
%  \leaders%
%  \cloze@hrule%
%  #1%
%  \kern 0pt%
%}

%\def\clozefill{\cloze@fill{\hfill}}
%\def\clozefil{\cloze@fill{\hfil}}

%%
% \clozefill{Lorem ipsum}
%
% Creates a cloze on one line with a fixed length.
%%
\newcommand{\clozefill}[1][]{%
  \cloze@set@local@options{#1}%
  \strut
  \directlua{cloze.hfill()}%
  \strut
}