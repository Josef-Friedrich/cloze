% https://tug.org/TUGboat/tb32-1/tb100isambert.pdf
\directlua{
   cloze_test = require('cloze-test')
   cloze_test.register_functions()
}

\newif\ifPLAINLUATEX

\directlua{
  cloze_test.set_if_plain_luatex()
}

\input cloze.tex

\ifPLAINLUATEX
  \def\createcatcodes{
    \bgroup
      \catcode`\\=12
      \catcode`\{=12
      \catcode`\}=12
      \catcode`\$=12
      \catcode`\&=12
      \catcode`\^^M=13
      \catcode`\#=12
      \catcode`\^=12
      \catcode`\_=12
      \catcode`\ =13
      \catcode`\~=12
      \catcode`\%=12
      \savecatcodetable 1
    \egroup
  }
  \createcatcodes

  \def\Space{ }
  \bgroup
    \catcode`\^^M=13\gdef^^M{\quitvmode\par}%
    \catcode`\ = 13\gdef {\quitvmode\Space}%
  \egroup
\else
\fi

\def\tEndVerbatim{}

\def\tUseLast{
   \directlua{cloze_test.use_last()}
}

\def\tLastVerbatim{
  \directlua{
    cloze_test.print_last_verbatim()
  }
}

\def\tAll{%
  \directlua{
    cloze_test.print_all()
  }%
}

\font\tTypewriterFontBigger=cmtt10 scaled \magstep3
\font\tTypewriterFontBig=cmtt10 scaled \magstep1
\font\tTypewriterFontNormal=cmtt10

\def\tTitle#1{%
  \noindent%
  {\tTypewriterFontBigger #1}%
}

\def\tDescription#1{%
  \noindent%
  {\tTypewriterFontNormal #1}%
}

\def\tComment#1{%
  \par\tDescription{#1:} %
}

\def\tTitleDesc#1#2{%
  \tTitle{#1}
  \par
  \tDescription{#2}
  \par
  {\noindent\tTypewriterFontNormal Test file: \jobname.tex}
  \par
  \hrule width 6cm
  \bigskip
}

\def\tSection#1{%
  \bigskip%
  \noindent%
  {\tTypewriterFontBig#1}%
  \bigskip%
}

\def\tShowHideText#1#2{%
  \par%
  \bigskip\bigskip%
  \noindent%
  {\tTypewriterFontNormal Cloze texts are #1 (visibility=#2):}%
  \par\bigskip%
}

\def\tShowCloze{%
  \clozeshow%
  \tShowHideText{displayed}{true}%
}

\def\tHideCloze{%
  \clozehide%
  \tShowHideText{hidden}{false}%
}

\def\tShowAndHide{
  \tShowCloze

  \TestExample

  \tHideCloze

  \TestExample
}
